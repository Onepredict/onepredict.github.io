{"componentChunkName":"component---src-templates-blog-post-js","path":"/sql-orm/","result":{"data":{"site":{"siteMetadata":{"title":"Onepredict Engineering"}},"markdownRemark":{"id":"c024443e-e16e-5384-ad53-4e9c9208850e","excerpt":"Intro ORM vs SQL OLTP와 OLAP 수정 API DB 구조 정리 성능 저하 원인 비고 마치며 Intro…","html":"<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#intro\">Intro</a></li>\n<li><a href=\"#orm-vs-sql\">ORM vs SQL</a></li>\n<li><a href=\"#oltp%EC%99%80-olap\">OLTP와 OLAP</a></li>\n<li><a href=\"#%EC%88%98%EC%A0%95-api\">수정 API</a></li>\n<li><a href=\"#db-%EA%B5%AC%EC%A1%B0\">DB 구조</a></li>\n<li><a href=\"#%EC%A0%95%EB%A6%AC\">정리</a></li>\n<li><a href=\"#%EC%84%B1%EB%8A%A5-%EC%A0%80%ED%95%98-%EC%9B%90%EC%9D%B8\">성능 저하 원인</a></li>\n<li><a href=\"#%EB%B9%84%EA%B3%A0\">비고</a></li>\n<li><a href=\"#%EB%A7%88%EC%B9%98%EB%A9%B0\">마치며</a></li>\n</ul>\n</div>\n<h2 id=\"intro\" style=\"position:relative;\"><a href=\"#intro\" aria-label=\"intro permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Intro</h2>\n<p>대규모 반도체 공장에서 여러 설비 데이터를 가공하고 운영하다 보면, 데이터베이스에 쌓인 여러 데이터를 활용해서 원하는 형태로 데이터를 가져올 수 있어야 하는 역량이 중요합니다.\n뿐만 아니라 부하가 큰 트랜잭션 쿼리를 날리다 보니 DA<sup id=\"fnref-주1\"><a href=\"#fn-주1\" class=\"footnote-ref\">주1</a></sup> 를 통해서 쿼리를 튜닝하는 일도 빈번한데요, API 성능개선을 하면서 Raw SQL과 ORM으로 DB에서 원하는 정보의 데이터를 가져오는 성능을 비교해 보려 합니다.</p>\n<h2 id=\"orm-vs-sql\" style=\"position:relative;\"><a href=\"#orm-vs-sql\" aria-label=\"orm vs sql permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ORM vs SQL</h2>\n<p>언제부터인가 ORM이 트렌드가 되고, 누구나 다 SQL보다는 ORM으로 DB 트랜잭션을 처리하기를 원하지만, 개인적으로 어떤 장점이 있기에 ORM을 사용하고 싶은가? 라는 질문에는 여러 개발자, 친구, 선배에게 물어봐도 그럴듯한 답변을 듣지 못하고 혼자서 많이 고민해 왔습니다.</p>\n<p>그나마 \"DB 의 종류에 구애받지 않기에\", \"개발 생산성을 높일 수 있어서\"라는 답변을 들었지만, 개인적으로 저를 설득할 만한 대답이 되지 않았습니다.</p>\n<blockquote>\n<p>개발 생산성을 높일 수 있다.</p>\n</blockquote>\n<p>규모가 작은 초기 시스템에서는 ERD을 작성할 필요가 없기에 개발 생산성을 높일 수 있다는 점에 공감하지만, 규모가 커진 상태에서는 개발 생산성 효과가 오히려 떨어지는 것이 아닌가 하는 의문이 있습니다.\n수십 ~ 수백 개의 테이블로 구성된 DB 구조를 ERD가 아닌 수천 줄짜리 코드를 보고 테이블 관계를 이해할 수 있나?</p>\n<blockquote>\n<p>가독성을 높일 수 있다</p>\n</blockquote>\n<p>프로그래밍 언어로 만든 함수는 '논리'가 생명이지만, DB를 다루는 SQL은 '데이터 정합성'이 생명입니다.\n똑같은 SQL도 개발 DB, 운영 DB 그리고 시간에 따라 데이터가 다르게 조회됩니다. 아래 본문처럼, ORM은 SQL 블록 단위로 코드를 작성한 구조가 얼핏 보면 가독성이 좋아 보일 수 있으나, 블록 단위 데이터를 까볼 수는 없습니다.\n반대로 Raw SQL은 거대한 SQL 구조에서 내부 블록 단위로 쿼리를 실행해 데이터를 확인해 볼 수 있고, 어떻게 수정해야 할 지 바로 확인이 가능합니다.</p>\n<blockquote>\n<p>성능에 대한 저하</p>\n</blockquote>\n<p>기본적으로 ORM 으로 데이터를 처리하는 게 SQL을 활용하는 것보다, 성능이 월등히 떨어집니다. (ORM 내부적으로 SQL로 변환하는 과정을 거치며, 조인이 많아질수록 성능을 기하급수적으로 감소합니다.)\n또한 튜닝이 필요한 시점에서는 결국 다시 SQL로 작성해야 하는 단점이 있습니다.</p>\n<p>하지만 최근 지하철을 타며 회사를 출근하다가 문득 이 논쟁에 대한 정답을 찾았습니다. 그것은 바로 OLTP 와 OLAP 서비스에 따라 다르다는 것!</p>\n<h2 id=\"oltp와-olap\" style=\"position:relative;\"><a href=\"#oltp%EC%99%80-olap\" aria-label=\"oltp와 olap permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>OLTP와 OLAP</h2>\n<p>이 용어는 주로 Database에 대해서 공부해본 사람이라면 한 번쯤은 들어 봤을 것으로 보입니다.</p>\n<p>OLTP (Online Transaction Processing)은 현재의 데이터 처리가 얼마나 정확하고, 무결한지가 중요합니다. 그렇기 때문에 주로 데이터의 저장, 삭제, 수정 등의 실질적인 데이터를 수정하는 작업을 의미하고, 단순 CRUD가 많은 서비스에서 주로 사용됩니다. 예시로 도메인 주도 설계에서, 여러 도메인을 정의하고 해당 도메인간의 연관관계 이벤트가 많이 발생하는 서비스라면 OLTP 에 가깝다고 표현할 수 있을 것 같습니다.</p>\n<p>OLAP ( Online Analytical Processing)는 이미 지정된 데이터를 바탕으로 어떤 정보를 제공하는지가 중요합니다. 따라서 OLAP는 데이터가 무결하고 정확하다는 전제를 바탕으로 고객 또는 사용자가 원하는 정보를 어떤식으로 표현하고 제공하는지를 의미합니다. 예시로 설비의 여러 생산성 지표나 모니터링 같은 데이터를 추출하거나, 회사의 년간 각 부서별 임금 상승률 같은 분석용 데이터를 주로 보여주는 서비스라면 OLAP에 가깝다고 표현할 수 있습니다.</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\">구분</th>\n<th align=\"center\">OLTP</th>\n<th align=\"center\">OLAP</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">속도</td>\n<td align=\"center\">수 초 이내</td>\n<td align=\"center\">수 초 이상 수 분 이내</td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">관리단위</td>\n<td align=\"center\">테이블</td>\n<td align=\"center\">분석된 정보</td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">최적화 방법</td>\n<td align=\"center\">트랜잭션 효율화, 무결성의 극대화</td>\n<td align=\"center\">조회속도, 정보의 가치, 편의성</td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">데이터 특성</td>\n<td align=\"center\">트랜잭션 중심</td>\n<td align=\"center\">정보 중심</td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">예시</td>\n<td align=\"center\">회원정보 수정</td>\n<td align=\"center\">1년 간의 주문 이기 트렌드</td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\">상품 주문</td>\n<td align=\"center\">한달간의 방문율 수익, 제품</td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\">댓글 남기기 및 수정</td>\n<td align=\"center\">10년간 A 회사의 직원별 매출 상승률</td>\n</tr>\n</tbody>\n</table>\n<p>정리를 하자면 단순한 데이터의 조회 및 저장이 주로 발생하는, 가볍지만 트래픽이 많은 서비스의 경우에는 ORM이 트랜드가 되고, 데이터를 가공하고 분석하는, 무겁지만 트래픽 건수가 상대적으로 적은 서비스에서는\nSQL이 많이 쓰이는 것으로 보입니다.</p>\n<h2 id=\"수정-api\" style=\"position:relative;\"><a href=\"#%EC%88%98%EC%A0%95-api\" aria-label=\"수정 api permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>수정 API</h2>\n<blockquote> companies/{company_id}/enterprise-dga-grade-status</blockquote>\n변압기의 DGA 가스를 측정해서, AI 알고리즘을 돌린 후, 최신 진단한 상태값과 바로 직전 진단한 DGA 의 상태값을 보내 설비 별 상태값의 추이를 보여주도록 하는 API 입니다.\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 867px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/675b89e49698ef9396013915fa786354/264eb/dga_dashboard.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.734375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACSUlEQVR42oWTTUhUURTHZ10Lg6AWSUQQ7YIWEUmU2QdSoKlEYWUSZQgtJIJokYgVbUywD+hzRiNEUbIkVASZwQrMTVJEiyGwNkVTzPuYefPuve/cf+fd53y06sCfc+7l3d89H+/GgmQKlBgEDT0DDQ6VFa4fPUawuAhjWqNslfG/Fgu6e6D31ELX1kHvDbUvUt0B6B07Qffug/jDQj4Pz/OQy7kIiECkQUqxJwRBwPdFl8Toxk3oQ/XQLcegjzZDN7VEPtT+g6CncQN0shay2SzLAQkXWuXNfggicwGtAHuv80HOprERuqEB+vAR6GaGtbdDnzrJ7UhEBzmb0DK/PkAsx4Glceh0OmoAw0oZBn13QE2toNMXQG0dHJ8AtZ4DdXSBOi8jGB4zwLBttmdjeKGfy7bh/M6gMDULksp0VBczFPNxiOcXIUYusa7ATz2EmOZ4qgv+xHnIzxMRkM31LQzPz8HLKfyxHbyYcaGEyd/01ADl5BnI21WQ/VUQA9Xw33VCTm+AfLUGYjwG+fGqAVIQlbz0RWJkWmB0RuBTOtoLYaWS5UQ75K3VkH3rGLgFfpKBL9dDjq+FGF0FuXQtAioBnyetyYNte8jaOZ6uj3zeNwOpALZBDmyEGtwN+aSGS+6AfL0JanYX+62cYY8BKlGA6zhwHBc5N/Q8dcuGZVmQUpSBYuw45N3NkIkaiAfbUZg7CzFZDZms5z5uY2DvyiRV6VDoiyquSz+2yqShlt9G+v4eyvoKlVmA+vkG6kcKgfvtv6+j8qX8BU5d/A5pbKxkAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"서브스테이션 2.0 대시보드\"\n        title=\"서브스테이션 2.0 대시보드\"\n        src=\"/static/675b89e49698ef9396013915fa786354/264eb/dga_dashboard.png\"\n        srcset=\"/static/675b89e49698ef9396013915fa786354/6f3f2/dga_dashboard.png 256w,\n/static/675b89e49698ef9396013915fa786354/01e7c/dga_dashboard.png 512w,\n/static/675b89e49698ef9396013915fa786354/264eb/dga_dashboard.png 867w\"\n        sizes=\"(max-width: 867px) 100vw, 867px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">서브스테이션 2.0 대시보드</figcaption>\n  </figure></p>\n<h2 id=\"db-구조\" style=\"position:relative;\"><a href=\"#db-%EA%B5%AC%EC%A1%B0\" aria-label=\"db 구조 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DB 구조</h2>\n<p>해당 시스템에서는 PostgresSQL DB를 사용했으며, 설비를 지칭하는 Asset 테이블과 DGA(유증류 가스)를 측정한 DataMtrBody 그리고 설비와, DGA 정보를 이용해 AI 알고리즘 결과를 저장한 AiMtrBodyDga 테이블을 이용하여 데이터를 가져옵니다. 구체적인 테이블 칼럼 설명은 보안상 생략합니다.</p>\n<center>  <h3>Before (ORM)</h3> </center>\n<center> 해당 방식은 SqlAlchemy의 ORM을 활용해서 데이터를 가져오는 형태의 데이터 입니다.</center>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># time 측정 </span>\n        start <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        math<span class=\"token punctuation\">.</span>factorial<span class=\"token punctuation\">(</span><span class=\"token number\">100000</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># asset 별 모든 측정일과 이전 측정일 추출</span>\n        asset_info <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n            session<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">(</span>\n                Asset<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">(</span><span class=\"token string\">\"asset_id\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                Asset<span class=\"token punctuation\">.</span>asset_name<span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">(</span><span class=\"token string\">\"asset_name\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                DataMtrBodyDga<span class=\"token punctuation\">.</span>acquisition_date<span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">(</span><span class=\"token string\">\"acquisition_date\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                func<span class=\"token punctuation\">.</span>lead<span class=\"token punctuation\">(</span>DataMtrBodyDga<span class=\"token punctuation\">.</span>acquisition_date<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span>over<span class=\"token punctuation\">(</span>\n                    partition_by<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>Asset<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span> Asset<span class=\"token punctuation\">.</span>asset_name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                    order_by<span class=\"token operator\">=</span>DataMtrBodyDga<span class=\"token punctuation\">.</span>acquisition_date<span class=\"token punctuation\">.</span>desc<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">(</span><span class=\"token string\">\"prev_acquisition_date\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span>select_from<span class=\"token punctuation\">(</span>Asset<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>DataMtrBodyDga<span class=\"token punctuation\">,</span> DataMtrBodyDga<span class=\"token punctuation\">.</span>asset_id <span class=\"token operator\">==</span> Asset<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token builtin\">filter</span><span class=\"token punctuation\">(</span>\n                Asset<span class=\"token punctuation\">.</span>company_id <span class=\"token operator\">==</span> company_id<span class=\"token punctuation\">,</span>\n                Asset<span class=\"token punctuation\">.</span>asset_type <span class=\"token operator\">==</span> <span class=\"token string\">\"MTR\"</span><span class=\"token punctuation\">,</span>\n                Asset<span class=\"token punctuation\">.</span>serial_no<span class=\"token punctuation\">.</span>in_<span class=\"token punctuation\">(</span>available_licenses<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span>order_by<span class=\"token punctuation\">(</span>\n                Asset<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span> Asset<span class=\"token punctuation\">.</span>asset_name<span class=\"token punctuation\">,</span> DataMtrBodyDga<span class=\"token punctuation\">.</span>acquisition_date<span class=\"token punctuation\">.</span>desc<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span>subquery<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># dataMtrBodyDga 테이블 기준 asset 별 최신 측정일과 바로 이전 측정일 추출</span>\n        asset_acquisition_info <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n            session<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">(</span>\n                asset_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>asset_id<span class=\"token punctuation\">,</span>\n                asset_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>asset_name<span class=\"token punctuation\">,</span>\n                func<span class=\"token punctuation\">.</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>asset_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>acquisition_date<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">(</span><span class=\"token string\">\"acquisition_date\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token keyword\">case</span><span class=\"token punctuation\">(</span>\n                    <span class=\"token punctuation\">[</span>\n                        <span class=\"token punctuation\">(</span>\n                            func<span class=\"token punctuation\">.</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>asset_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>prev_acquisition_date<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span>\n                            func<span class=\"token punctuation\">.</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>asset_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>acquisition_date<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token punctuation\">(</span>\n                            func<span class=\"token punctuation\">.</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>asset_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>prev_acquisition_date<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span>\n                            func<span class=\"token punctuation\">.</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>asset_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>prev_acquisition_date<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token punctuation\">]</span>\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">(</span><span class=\"token string\">\"prev_acquisition_date\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span>select_from<span class=\"token punctuation\">(</span>asset_info<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span>group_by<span class=\"token punctuation\">(</span>asset_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>asset_id<span class=\"token punctuation\">,</span> asset_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>asset_name<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span>subquery<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># asset 측정일 기준별 진단 결과 건수 추출</span>\n        diag_info <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n            session<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">(</span>\n                DataMtrBodyDga<span class=\"token punctuation\">.</span>asset_id<span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">(</span><span class=\"token string\">\"asset_id\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                DataMtrBodyDga<span class=\"token punctuation\">.</span>acquisition_date<span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">(</span><span class=\"token string\">\"acquisition_date\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                AiMtrBodyDga<span class=\"token punctuation\">.</span>ai_diagnosis_result<span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">(</span><span class=\"token string\">\"ai_diagnosis_result\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span>select_from<span class=\"token punctuation\">(</span>DataMtrBodyDga<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># LEFT OUTER JOIN 의 기준 테이블을 설정하기 위해 사용</span>\n            <span class=\"token punctuation\">.</span>outerjoin<span class=\"token punctuation\">(</span>Asset<span class=\"token punctuation\">,</span> DataMtrBodyDga<span class=\"token punctuation\">.</span>asset_id <span class=\"token operator\">==</span> Asset<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span>outerjoin<span class=\"token punctuation\">(</span>\n                AiMtrBodyDga<span class=\"token punctuation\">,</span>\n                DataMtrBodyDga<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span> <span class=\"token operator\">==</span> AiMtrBodyDga<span class=\"token punctuation\">.</span>data_mtr_body_dga_id<span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token builtin\">filter</span><span class=\"token punctuation\">(</span>\n                Asset<span class=\"token punctuation\">.</span>company_id <span class=\"token operator\">==</span> company_id<span class=\"token punctuation\">,</span>\n                Asset<span class=\"token punctuation\">.</span>asset_type <span class=\"token operator\">==</span> <span class=\"token string\">\"MTR\"</span><span class=\"token punctuation\">,</span>\n                Asset<span class=\"token punctuation\">.</span>serial_no<span class=\"token punctuation\">.</span>in_<span class=\"token punctuation\">(</span>available_licenses<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span>subquery<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n        <span class=\"token comment\"># asset 별 최신 측정일 기준 상태 건수</span>\n        query1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n            session<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">(</span>\n                func<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">(</span>diag_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>ai_diagnosis_result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">(</span><span class=\"token string\">\"total_cnt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                func<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">(</span>\n                    <span class=\"token keyword\">case</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>diag_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>ai_diagnosis_result <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"NORMAL\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">(</span><span class=\"token string\">\"normal_cnt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                func<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">(</span>\n                    <span class=\"token keyword\">case</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>diag_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>ai_diagnosis_result <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"CAUTION\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">(</span><span class=\"token string\">\"caution_cnt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                func<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">(</span>\n                    <span class=\"token keyword\">case</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>diag_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>ai_diagnosis_result <span class=\"token operator\">==</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"WARNING\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">(</span><span class=\"token string\">\"warning_cnt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                func<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">(</span>\n                    <span class=\"token keyword\">case</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>diag_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>ai_diagnosis_result <span class=\"token operator\">==</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"CRITICAL\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">(</span><span class=\"token string\">\"critical_cnt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                func<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">(</span>\n                    <span class=\"token keyword\">case</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>diag_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>ai_diagnosis_result <span class=\"token operator\">==</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"FAULT\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">(</span><span class=\"token string\">\"fault_cnt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span>select_from<span class=\"token punctuation\">(</span>asset_acquisition_info<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># LEFT OUTER JOIN 의 기준 테이블을 설정하기 위해 사용</span>\n            <span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>\n                diag_info<span class=\"token punctuation\">,</span>\n                and_<span class=\"token punctuation\">(</span>\n                    asset_acquisition_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>asset_id <span class=\"token operator\">==</span> diag_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>asset_id<span class=\"token punctuation\">,</span>\n                    asset_acquisition_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>acquisition_date\n                    <span class=\"token operator\">==</span> diag_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>acquisition_date<span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># asset 별 이전 측정일 기준 상태 건수</span>\n        query2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n            session<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">(</span>\n                func<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">(</span>diag_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>ai_diagnosis_result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">(</span><span class=\"token string\">\"total_cnt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                func<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">(</span>\n                    <span class=\"token keyword\">case</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>diag_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>ai_diagnosis_result <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"NORMAL\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">(</span><span class=\"token string\">\"normal_cnt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                func<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">(</span>\n                    <span class=\"token keyword\">case</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>diag_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>ai_diagnosis_result <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"CAUTION\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">(</span><span class=\"token string\">\"caution_cnt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                func<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">(</span>\n                    <span class=\"token keyword\">case</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>diag_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>ai_diagnosis_result <span class=\"token operator\">==</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"WARNING\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">(</span><span class=\"token string\">\"warning_cnt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                func<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">(</span>\n                    <span class=\"token keyword\">case</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>diag_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>ai_diagnosis_result <span class=\"token operator\">==</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"CRITICAL\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">(</span><span class=\"token string\">\"critical_cnt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                func<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">(</span>\n                    <span class=\"token keyword\">case</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>diag_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>ai_diagnosis_result <span class=\"token operator\">==</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"FAULT\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">(</span><span class=\"token string\">\"fault_cnt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span>select_from<span class=\"token punctuation\">(</span>asset_acquisition_info<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># LEFT OUTER JOIN 의 기준 테이블을 설정하기 위해 사용</span>\n            <span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>\n                diag_info<span class=\"token punctuation\">,</span>\n                and_<span class=\"token punctuation\">(</span>\n                    asset_acquisition_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>asset_id <span class=\"token operator\">==</span> diag_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>asset_id<span class=\"token punctuation\">,</span>\n                    asset_acquisition_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>prev_acquisition_date\n                    <span class=\"token operator\">==</span> diag_info<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span>acquisition_date<span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n\n        end <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"****************************************************\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>end <span class=\"token operator\">-</span> start<span class=\"token punctuation\">:</span><span class=\"token format-spec\">.5f</span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> sec\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"****************************************************\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<center>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\">1회 시도 (DB 캐시 제거)</th>\n<th align=\"center\">2회 시도 (DB 캐시 제거)</th>\n<th align=\"center\">3회 시도 (DB 캐시 제거)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">1차 시도</td>\n<td align=\"center\"><span style=\"color:blue\">6.62579초</span></td>\n<td align=\"center\"><span style=\"color:blue\">6.28475초</span></td>\n<td align=\"center\"><span style=\"color:blue\">6.25671초</span></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">2차 시도</td>\n<td align=\"center\">5.42588초</td>\n<td align=\"center\">5.30851초</td>\n<td align=\"center\">4.69481초</td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">3차 시도</td>\n<td align=\"center\">4.86993초</td>\n<td align=\"center\">4.90473초</td>\n<td align=\"center\">4.73450초</td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n</tbody>\n</table>\n</center>\n<center>  <h3>After (SQL)</h3> </center>\n<center> 해당 방식은 SqlAlchemy 의 Core를 활용해서 Raw SQL 형태로 데이터를 가져오는 데이터 입니다.\n기존 'IN' 절로 처리한 부분을 'ANY'로 사용한 이유는, PostgreSQL에서 varchar 타입의 칼럼의 경우, SqlALchemy는 Record 타입으로 인지하고 값을 비교하여 에러가 납니다.\n해당 에러에 대해서 아래와 같이 변환하여 사용합니다.\n</center>\n<p><em>ANY (select unnest(:available_licenses))</em></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># time 측정 </span>\n        start <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        math<span class=\"token punctuation\">.</span>factorial<span class=\"token punctuation\">(</span><span class=\"token number\">100000</span><span class=\"token punctuation\">)</span>\n\n        sql_statement <span class=\"token operator\">=</span> text<span class=\"token punctuation\">(</span>\n            <span class=\"token triple-quoted-string string\">\"\"\"\n                     WITH asset_info AS (  \n                        SELECT a.asset_id, a.asset_name  \n                            ,MAX(a.acquisition_date) AS acquisition_date  \n                            ,CASE WHEN MAX(a.prev_acquisition_date) IS NULL THEN MAX(a.acquisition_date)  \n                                   WHEN MAX(a.prev_acquisition_date) IS NOT NULL THEN MAX(a.prev_acquisition_date)  \n                                   END AS prev_acquisition_date  \n                        FROM ( \n                               SELECT a.id AS asset_id  \n                                      ,a.asset_name AS asset_name  \n                                      ,dmbd.acquisition_date  \n                                      ,LEAD(dmbd.acquisition_date,1) \n                                          OVER (PARTITION BY a.id, a.asset_name ORDER BY dmbd.acquisition_date DESC ) \n                                          AS prev_acquisition_date  \n                              FROM substation.asset a INNER JOIN substation.data_mtr_body_dga dmbd  \n                              ON a.id = dmbd.asset_id  \n                              WHERE a.asset_type = 'MTR' \n                              AND a.company_id = :company_id  \n                              AND a.serial_no = ANY (SELECT UNNEST(:available_licenses))\n                              ORDER BY a.id, a.asset_name, dmbd.acquisition_date DESC  \n                           ) a  \n                       GROUP BY a.asset_id, a.asset_name   \n                     ), diag_info AS (  \n                           SELECT dmbd.asset_id, dmbd.acquisition_date , ambd.ai_diagnosis_result \n                           FROM substation.data_mtr_body_dga dmbd LEFT OUTER JOIN substation.asset a \n                           ON dmbd.asset_id = a.id LEFT OUTER JOIN substation.ai_mtr_body_dga ambd  \n                           ON dmbd.id = ambd.data_mtr_body_dga_id \n                           WHERE a.company_id = :company_id  \n                           AND a.serial_no = ANY (SELECT UNNEST(:available_licenses))\n                           AND a.asset_type = 'MTR' \n                           ) \n                     SELECT COUNT(*) AS TOTAL_CNT  \n                           ,COUNT(CASE WHEN b.ai_diagnosis_result = 0 THEN 'NORMAL' END ) AS NORMAL \n                           ,COUNT(CASE WHEN b.ai_diagnosis_result = 1 THEN 'CAUTION' END ) AS CAUTION \n                           ,COUNT(CASE WHEN b.ai_diagnosis_result = 2 THEN 'WARNING' END ) AS WARNING \n                           ,COUNT(CASE WHEN b.ai_diagnosis_result = 3 THEN 'CRITICAL' END ) AS CRITICAL \n                           ,COUNT(CASE WHEN b.ai_diagnosis_result = 4 THEN 'FAULT' END ) AS FAULT \n                     FROM asset_info a LEFT OUTER JOIN diag_info b \n                     ON a.asset_id = b.asset_id \n                     WHERE a.acquisition_date = b.acquisition_date \n                     UNION ALL  \n                     SELECT COUNT(*) AS TOTAL_CNT  \n                           ,COUNT(CASE WHEN b.ai_diagnosis_result = 0 THEN 'NORMAL' END ) AS NORMAL \n                           ,COUNT(CASE WHEN b.ai_diagnosis_result = 1 THEN 'CAUTION' END ) AS CAUTION \n                           ,COUNT(CASE WHEN b.ai_diagnosis_result = 2 THEN 'WARNING' END ) AS WARNING \n                           ,COUNT(CASE WHEN b.ai_diagnosis_result = 3 THEN 'CRITICAL' END ) AS CRITICAL \n                           ,COUNT(CASE WHEN b.ai_diagnosis_result = 4 THEN 'FAULT' END ) AS FAULT \n                     FROM asset_info a LEFT OUTER JOIN diag_info b \n                     ON a.asset_id = b.asset_id  \n                     WHERE a.prev_acquisition_date = b.acquisition_date  \n                \"\"\"</span>\n                    <span class=\"token punctuation\">)</span>\n\n        result <span class=\"token operator\">=</span> session<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span>sql_statement<span class=\"token punctuation\">,</span><span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"available_licenses\"</span><span class=\"token punctuation\">:</span> available_licenses<span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"company_id\"</span><span class=\"token punctuation\">:</span> company_id\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n        end <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"****************************************************\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>end <span class=\"token operator\">-</span> start<span class=\"token punctuation\">:</span><span class=\"token format-spec\">.5f</span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> sec\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"****************************************************\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<center>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\">1회 시도 (DB 캐시 제거)</th>\n<th align=\"center\">2회 시도 (DB 캐시 제거)</th>\n<th align=\"center\">3회 시도 (DB 캐시 제거)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">1차 시도</td>\n<td align=\"center\"><span style=\"color:blue\">4.37999초</span></td>\n<td align=\"center\"><span style=\"color:blue\">4.64817초</span></td>\n<td align=\"center\"><span style=\"color:blue\">4.29508초</span></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">2차 시도</td>\n<td align=\"center\">1.76666초</td>\n<td align=\"center\">1.64863초</td>\n<td align=\"center\">1.58068초</td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">3차 시도</td>\n<td align=\"center\">1.61587초</td>\n<td align=\"center\">1.56709초</td>\n<td align=\"center\">1.59817초</td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n</tbody>\n</table>\n</center>\n<h2 id=\"정리\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정리</h2>\n<p>SQL의 처리 과정이나 로직에 대해서는 따로 설명하지는 않지만, DB 캐시에 의한 성능 효과를 고려해서 1 try 기준의 평균값으로 시간을 측정했을 때 Before (ORM) <em>6.38908</em>,  After(SQL) <em>4.44108</em> 아래와 같이 구해집니다.</p>\n<h4 style=\"color:#003163\">(4.44108 / 6.38908 ) x 100 = 69.51 %</h4>\n<span style=\"color:#003163\"><b>소요 시간을 기존 대비 30.48%가량 줄일 수 있었습니다.</b></span> <br><br>\n<p>다만 흥미로운 부분으로 DB 캐시 효과를 고려한 3try 기준의 평균값으로 측정하면 아래와 같이 구해집니다. Before (ORM) 4.83638, After (SQL)  1.59371</p>\n<h4 style=\"color:#003163\">(1.59371 / 4.83638 ) x 100 = 32.95 %</h4>\n<span style=\"color:#003163\"><b>소요 시간을 기존 대비 67%가량 줄일 수 있었습니다.</b></span><br><br>\n<p>이 수치는 개발 환경에서 진행된 테스트로, 테이블에 적재된 데이터 용량과 DB 부하 상태에 따라서 수치에 영향을 받을 수 있으며, 그럴 경우 성능은 더 차이가 날 것으로 보입니다.</p>\n<ul>\n<li>DB 조인이 더 많아지는 경우에도 마찬가지입니다.</li>\n</ul>\n<h2 id=\"성능-저하-원인\" style=\"position:relative;\"><a href=\"#%EC%84%B1%EB%8A%A5-%EC%A0%80%ED%95%98-%EC%9B%90%EC%9D%B8\" aria-label=\"성능 저하 원인 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>성능 저하 원인</h2>\n<p>그렇다면 <em>'ORM 이 변경한 쿼리 구조가 성능이 나쁜 건지' 혹은 'ORM 이 SQL로 변경하는 과정에서 오랜 걸린 건지?</em> 에 대한 궁금중이 생길 수 있을 것 같은데요. ORM 이 변경한 쿼리로 직접 실행했을 때의 결과는 아래와 같았습니다.</p>\n<center>  <h3>ORM 으로 변환된 SQL</h3> </center>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">start</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">time</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">time</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    math<span class=\"token punctuation\">.</span>factorial<span class=\"token punctuation\">(</span><span class=\"token number\">100000</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">session</span> <span class=\"token operator\">=</span> DatabaseFactory<span class=\"token punctuation\">.</span>create_session<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    try:\n        company_name <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">session</span><span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">(</span>Company<span class=\"token punctuation\">.</span>company_name<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span>filter<span class=\"token punctuation\">(</span>Company<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span><span class=\"token operator\">=</span> company_id<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">first</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span>company_name\n        <span class=\"token punctuation\">)</span>\n        available_licenses <span class=\"token operator\">=</span> LicenseUtils<span class=\"token punctuation\">.</span>license_check_all<span class=\"token punctuation\">(</span>company_name<span class=\"token operator\">=</span>company_name<span class=\"token punctuation\">)</span>\n\n        query_1 <span class=\"token operator\">=</span> <span class=\"token keyword\">text</span><span class=\"token punctuation\">(</span>\n            <span class=\"token string\">\"\"\"\n                     SELECT count(anon_1.ai_diagnosis_result) AS total_cnt\n                    , count(CASE WHEN (anon_1.ai_diagnosis_result = 0) THEN 'NORMAL' END) AS normal_cnt\n                    , count(CASE WHEN (anon_1.ai_diagnosis_result = 1) THEN 'CAUTION' END) AS caution_cnt\n                    , count(CASE WHEN (anon_1.ai_diagnosis_result = 2) THEN 'WARNING' END) AS warning_cnt\n                    , count(CASE WHEN (anon_1.ai_diagnosis_result = 3) THEN 'CRITICAL' END) AS critical_cnt\n                    , count(CASE WHEN (anon_1.ai_diagnosis_result = 4) THEN 'FAULT' END) AS fault_cnt \n            FROM (\n                    SELECT anon_3.asset_id AS asset_id\n                            , anon_3.asset_name AS asset_name\n                            , MAX(anon_3.acquisition_date) AS acquisition_date\n                            , CASE WHEN (MAX(anon_3.prev_acquisition_date) IS NULL) THEN MAX(anon_3.acquisition_date) \n                                    WHEN (MAX(anon_3.prev_acquisition_date) IS NOT NULL) THEN MAX(anon_3.prev_acquisition_date) \n                            END AS prev_acquisition_date \n            FROM (\n                    SELECT substation.asset.id AS asset_id\n                        , substation.asset.asset_name AS asset_name\n                        , substation.data_mtr_body_dga.acquisition_date AS acquisition_date\n                        , LEAD(substation.data_mtr_body_dga.acquisition_date, 1) \n                            OVER (PARTITION BY substation.asset.id, substation.asset.asset_name \n                                    ORDER BY substation.data_mtr_body_dga.acquisition_date DESC\n                            ) AS prev_acquisition_date \n                    FROM substation.asset JOIN substation.data_mtr_body_dga \n                    ON substation.data_mtr_body_dga.asset_id = substation.asset.id \n                    WHERE substation.asset.company_id = :company_id  \n                    AND substation.asset.asset_type = 'MTR'\n                    AND substation.asset.serial_no = ANY (SELECT UNNEST(:available_licenses))\n                    ORDER BY substation.asset.id, substation.asset.asset_name, substation.data_mtr_body_dga.acquisition_date DESC\n                    ) AS anon_3 \n            GROUP BY anon_3.asset_id, anon_3.asset_name) AS anon_2 JOIN \n                (\n                    SELECT substation.data_mtr_body_dga.asset_id AS asset_id\n                        , substation.data_mtr_body_dga.acquisition_date AS acquisition_date\n                        , substation.ai_mtr_body_dga.ai_diagnosis_result AS ai_diagnosis_result \n                    FROM substation.data_mtr_body_dga LEFT OUTER JOIN substation.asset \n                    ON substation.data_mtr_body_dga.asset_id = substation.asset.id \n                    LEFT OUTER JOIN substation.ai_mtr_body_dga \n                    ON substation.data_mtr_body_dga.id = substation.ai_mtr_body_dga.data_mtr_body_dga_id \n                    WHERE substation.asset.company_id = :company_id  \n                    AND substation.asset.asset_type = 'MTR'\n                    AND substation.asset.serial_no = ANY (SELECT UNNEST(:available_licenses))\n                ) AS anon_1 \n            ON anon_2.asset_id = anon_1.asset_id \n            AND anon_1.acquisition_date = anon_2.acquisition_date \n            LIMIT 1\n                \"\"\"</span>\n        <span class=\"token punctuation\">)</span>\n\n        sql_result1 <span class=\"token operator\">=</span> <span class=\"token keyword\">session</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">execute</span><span class=\"token punctuation\">(</span>\n            query_1<span class=\"token punctuation\">,</span>\n            {\n                <span class=\"token string\">\"available_licenses\"</span>: available_licenses<span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"company_id\"</span>: company_id<span class=\"token punctuation\">,</span>\n            }<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span>\n\n        query_2 <span class=\"token operator\">=</span> <span class=\"token keyword\">text</span><span class=\"token punctuation\">(</span>\n            <span class=\"token string\">\"\"\"\n                     SELECT count(anon_1.ai_diagnosis_result) AS total_cnt\n                    , count(CASE WHEN (anon_1.ai_diagnosis_result = 0) THEN 'NORMAL' END) AS normal_cnt\n                    , count(CASE WHEN (anon_1.ai_diagnosis_result = 1) THEN 'CAUTION' END) AS caution_cnt\n                    , count(CASE WHEN (anon_1.ai_diagnosis_result = 2) THEN 'WARNING' END) AS warning_cnt\n                    , count(CASE WHEN (anon_1.ai_diagnosis_result = 3) THEN 'CRITICAL' END) AS critical_cnt\n                    , count(CASE WHEN (anon_1.ai_diagnosis_result = 4) THEN 'FAULT' END) AS fault_cnt \n            FROM (\n                    SELECT anon_3.asset_id AS asset_id\n                            , anon_3.asset_name AS asset_name\n                            , MAX(anon_3.acquisition_date) AS acquisition_date\n                            , CASE WHEN (MAX(anon_3.prev_acquisition_date) IS NULL) THEN MAX(anon_3.acquisition_date) \n                                    WHEN (MAX(anon_3.prev_acquisition_date) IS NOT NULL) THEN MAX(anon_3.prev_acquisition_date) \n                            END AS prev_acquisition_date \n            FROM (\n                    SELECT substation.asset.id AS asset_id\n                        , substation.asset.asset_name AS asset_name\n                        , substation.data_mtr_body_dga.acquisition_date AS acquisition_date\n                        , LEAD(substation.data_mtr_body_dga.acquisition_date, 1) \n                            OVER (PARTITION BY substation.asset.id, substation.asset.asset_name \n                                    ORDER BY substation.data_mtr_body_dga.acquisition_date DESC\n                            ) AS prev_acquisition_date \n                    FROM substation.asset JOIN substation.data_mtr_body_dga \n                    ON substation.data_mtr_body_dga.asset_id = substation.asset.id \n                    WHERE substation.asset.company_id = :company_id  \n                    AND substation.asset.asset_type = 'MTR'\n                    AND substation.asset.serial_no = ANY (SELECT UNNEST(:available_licenses))\n                    ORDER BY substation.asset.id, substation.asset.asset_name, substation.data_mtr_body_dga.acquisition_date DESC\n                    ) AS anon_3 \n            GROUP BY anon_3.asset_id, anon_3.asset_name) AS anon_2 JOIN \n                (\n                    SELECT substation.data_mtr_body_dga.asset_id AS asset_id\n                        , substation.data_mtr_body_dga.acquisition_date AS acquisition_date\n                        , substation.ai_mtr_body_dga.ai_diagnosis_result AS ai_diagnosis_result \n                    FROM substation.data_mtr_body_dga LEFT OUTER JOIN substation.asset \n                    ON substation.data_mtr_body_dga.asset_id = substation.asset.id \n                    LEFT OUTER JOIN substation.ai_mtr_body_dga \n                    ON substation.data_mtr_body_dga.id = substation.ai_mtr_body_dga.data_mtr_body_dga_id \n                    WHERE substation.asset.company_id = :company_id  \n                    AND substation.asset.asset_type = 'MTR'\n                    AND substation.asset.serial_no = ANY (SELECT UNNEST(:available_licenses))\n                ) AS anon_1 \n            ON anon_2.asset_id = anon_1.asset_id \n            AND anon_1.acquisition_date = anon_2.prev_acquisition_date \n            LIMIT 1\n                \"\"\"</span>\n        <span class=\"token punctuation\">)</span>\n\n        sql_result2 <span class=\"token operator\">=</span> <span class=\"token keyword\">session</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">execute</span><span class=\"token punctuation\">(</span>\n            query_2<span class=\"token punctuation\">,</span>\n            {\n                <span class=\"token string\">\"available_licenses\"</span>: available_licenses<span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"company_id\"</span>: company_id<span class=\"token punctuation\">,</span>\n            }<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span>\n\n        results1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>rowproxy<span class=\"token punctuation\">.</span>_mapping <span class=\"token keyword\">for</span> rowproxy <span class=\"token operator\">in</span> sql_result1<span class=\"token punctuation\">]</span>\n        results2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>rowproxy<span class=\"token punctuation\">.</span>_mapping <span class=\"token keyword\">for</span> rowproxy <span class=\"token operator\">in</span> sql_result2<span class=\"token punctuation\">]</span>\n\n        <span class=\"token keyword\">end</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">time</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">time</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"****************************************************\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>f<span class=\"token string\">\"{end - start:.5f} sec\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"****************************************************\"</span><span class=\"token punctuation\">)</span>\n\n        responses <span class=\"token operator\">=</span> {<span class=\"token string\">\"current\"</span>: results1<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"prev\"</span>: results2<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>}</code></pre></div>\n<center>  <b>결과 ORM 이 가공한 Raw SQL 로 실행 시</b></center> <br/>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\">1회 시도 (DB 캐시 제거)</th>\n<th align=\"center\">2회 시도 (DB 캐시 제거)</th>\n<th align=\"center\">3회 시도 (DB 캐시 제거)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">1차 시도</td>\n<td align=\"center\"><span style=\"color:blue\">4.68825초</span></td>\n<td align=\"center\"><span style=\"color:blue\">4.95818초</span></td>\n<td align=\"center\"><span style=\"color:blue\">4.51720초</span></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">2차 시도</td>\n<td align=\"center\">1.86746초</td>\n<td align=\"center\">1.88096초</td>\n<td align=\"center\">1.97292초</td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">3차 시도</td>\n<td align=\"center\">1.83698초</td>\n<td align=\"center\">1.87081 초</td>\n<td align=\"center\">1.87755초</td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n</tbody>\n</table>\n<center> <b>결과 ORM으로 실행한 시</b> </center> <br/>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"center\">1회 시도 (DB 캐시 제거)</th>\n<th align=\"center\">2회 시도 (DB 캐시 제거)</th>\n<th align=\"center\">3회 시도 (DB 캐시 제거)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">1차 시도</td>\n<td align=\"center\"><span style=\"color:blue\">6.62579초</span></td>\n<td align=\"center\"><span style=\"color:blue\">6.28475초</span></td>\n<td align=\"center\"><span style=\"color:blue\">6.25671초</span></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">2차 시도</td>\n<td align=\"center\"><span style=\"color:orange\">5.42588초</span></td>\n<td align=\"center\"><span style=\"color:orange\">5.30851초</span></td>\n<td align=\"center\"><span style=\"color:orange\">4.69481 초</span></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">3차 시도</td>\n<td align=\"center\"><span style=\"color:orange\">4.86993초</span></td>\n<td align=\"center\"><span style=\"color:orange\">4.90473초</span></td>\n<td align=\"center\"><span style=\"color:orange\">4.734509초</span></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n</tbody>\n</table>\n<p>DB 캐싱에 의한 성능향상을 고려해서 1try 의 경우에 한해서, 비교해 보면 ORM 으로 조회했을 때와 Raw SQL 로 조회 했을때를 비교해보면 아래와 같습니다.</p>\n<blockquote>\n<p>ORM -> SQL 로 변경하는데 소요되는 시간 약 1.67 초 정도 소요</p>\n</blockquote>\n<p>직접 짠 Raw SQL 구조 대비 약 0.28 초 정도 성능 저하</p>\n<p>직접 짠 SQL 은 UNION ALL 을 사용한 반면에, ORM 에서는 쿼리 2번을 조회 하도록 했습니다. 다만 실제 비교 수치에서 유의미한 차이는 없었고, ORM 에서는 가독성을 향상 시킬 수 있어서(코드 감소) UNION ALL 대신 2개로 분할 해서 사용했었습니다.</p>\n<blockquote>\n<p>ORM 으로 실행한 코드는 DB 캐싱에 의한 이득에 있어서, Raw SQL 보다 매우 비효율적인 모습을 보였습니다. 해당 원인으로 추정해보기에는, <em>IN 절을 사용하는 것에 있는것으로 판단</em>됩니다.</p>\n</blockquote>\n<p>사실 SQL 튜닝 관점에서도 수많은 데이터를 IN 절을 통해서 받도록 하는 것은 좋지 못한 행동이지만, ORM 이 수많은 파라미터를 IN 절로 받도록 변환하는 과정에서 엄청 긴 SQL 을 만들게 되고, SQL 로 가공하는 시간과 더불어 캐싱효과를 제대로 누리지 못하게 한 것으로 보입니다.</p>\n<center>  <h3>ORM 이 가공한 SQL 로그</h3> </center>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token operator\">AND</span> substation<span class=\"token punctuation\">.</span>asset<span class=\"token punctuation\">.</span>serial_no <span class=\"token operator\">IN</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_1<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_2<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_3<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_4<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_5<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_6<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_7<span class=\"token punctuation\">)</span>s\n\t\t\t<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_8<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_9<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_10<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_11<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_12<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_13<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_14<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_15<span class=\"token punctuation\">)</span>s\n\t\t\t<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_16<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_17<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_18<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_19<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_20<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_21<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_22<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_23<span class=\"token punctuation\">)</span>s\n\t\t\t<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_24<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_25<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_26<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_27<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_28<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_29<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_30<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_31<span class=\"token punctuation\">)</span>s\n\t\t\t<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_32<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_33<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_34<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_35<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_36<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_37<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_38<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_39<span class=\"token punctuation\">)</span>s\n\t\t\t<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_40<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_41<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_42<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_43<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_44<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_45<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_46<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_47<span class=\"token punctuation\">)</span>s\n\t\t\t<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_48<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_49<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_50<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_51<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_52<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_53<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_54<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_55<span class=\"token punctuation\">)</span>s\n\t\t\t<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_56<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_57<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_58<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_59<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_60<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_61<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_62<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_63<span class=\"token punctuation\">)</span>s\n\t\t\t<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_64<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_65<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_66<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_67<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_68<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_69<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_70<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_71<span class=\"token punctuation\">)</span>s\n\t\t\t<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_72<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_73<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_74<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_75<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_76<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_77<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_78<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_79<span class=\"token punctuation\">)</span>s\n\t\t\t<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_80<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_81<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_82<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_83<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_84<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_85<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_86<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_87<span class=\"token punctuation\">)</span>s\n\t\t\t<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_88<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_89<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_90<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_91<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_92<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_93<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_94<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_95<span class=\"token punctuation\">)</span>s\n\t\t\t<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_96<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_97<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_98<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_99<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_100<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_101<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_102<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_103<span class=\"token punctuation\">)</span>s\n\t\t\t<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_104<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_105<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_106<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_107<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_108<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_109<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_110<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_111<span class=\"token punctuation\">)</span>s\n\t\t\t<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_112<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_113<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_114<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_115<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_116<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_117<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_118<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_119<span class=\"token punctuation\">)</span>s\n\t\t\t<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_120<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_121<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_122<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_123<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_124<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_125<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_126<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_127<span class=\"token punctuation\">)</span>s\n\t\t\t<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_128<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_129<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_130<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_131<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_132<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_133<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_134<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_135<span class=\"token punctuation\">)</span>s\n\t\t\t<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_136<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_137<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_138<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_139<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_140<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_141<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_142<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_143<span class=\"token punctuation\">)</span>s\n\t\t\t<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_144<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_145<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_146<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_147<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_148<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_149<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_150<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_151<span class=\"token punctuation\">)</span>s\n\t\t\t<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_152<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_153<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_154<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_155<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_156<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_157<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_158<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>serial_no_1_159<span class=\"token punctuation\">)</span>s\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\t\t</code></pre></div>\n<center>  <h3>Raw SQL 로 실행한 로그</h3> </center>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token operator\">AND</span> a<span class=\"token punctuation\">.</span>serial_no <span class=\"token operator\">=</span> <span class=\"token keyword\">ANY</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> UNNEST<span class=\"token punctuation\">(</span><span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>available_licenses<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"비고\" style=\"position:relative;\"><a href=\"#%EB%B9%84%EA%B3%A0\" aria-label=\"비고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>비고</h2>\n<p>ORM 에서 성능 관련 얘기를 할 때는 보통 기본적으로 N+1 이슈에 대해서 많이 다루는데요, 이번 글에서는 ORM 의 구조적인 형태로 발생하는 트랜잭션 비효율을 다루기보다는 동일한 형태의 테이블 조인으로 데이터를 조회했을 때,\n발생하는 성능 이슈에 대해서 비교해 보는 글을 적어봤습니다.</p>\n<p>또한 해당 글은 Backend 서버와 Database 서버 간 로컬 망에서 랜선 연결을 통해 측정한 데이터이며, DB 데이터 모수도 그저 5,500여 건의 데이터를 가지고 측정한 데이터이기에, 실 운영환경에서는 좀 더 극적인 효과를 기대할 수 있을 것으로 기대합니다.</p>\n<h2 id=\"마치며\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EC%B9%98%EB%A9%B0\" aria-label=\"마치며 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마치며</h2>\n<p>ORM 진영과 SQL 진영의 열띤 토론에 참여했었던 1인으로서, 개인적으로 2년 넘게 고민해 온 주제였습니다. 이 글의 내용만 본다면 SQL 진영의 승리처럼 보일 수 있지만, 이글을 작성하고 준비하면서 새로운 인사이트를 얻게 되었습니다.\n바로 ORM 만이 가지고 있는 '특별한 장점'이 있다는 점과 DB 연산 비용 못지않게 중요한 요소가 바로 '네트워크 비용'이라는 점입니다. MSA 정말 좋은 건가?</p>\n<p>또한 이런 결괏값은 어디까지나 OLAP 시스템 관점에서 작성한 글로, 복잡하지 않은 쿼리를 가진 OLTP 시스템이라면 ORM 도 충분히 사용하기 좋은 매력적인 도구라고 생각됩니다,\nORM 이 가지고 있는 장점과, 성능 개선 포인트가 궁금하시다면 다음 편을 참고해 주세요.</p>\n<p><a href=\"https://www.owl-dev.me/blog/68\">https://www.owl-dev.me/blog/68</a> <sup id=\"fnref-주2\"><a href=\"#fn-주2\" class=\"footnote-ref\">주2</a></sup></p>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-주1\">DA 와 DBA 란?  <a href=\"https://dataonair.or.kr/db-tech-reference/d-story/data-story/?mod=document&#x26;uid=63217\">블로그</a><a href=\"#fnref-%EC%A3%BC1\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-주2\"><a href=\"https://www.owl-dev.me/\">부엉이 블로그</a><a href=\"#fnref-%EC%A3%BC2\" class=\"footnote-backref\">↩</a></li>\n</ol>\n</div>","fields":{"slug":"/sql-orm/"},"frontmatter":{"title":"SQL VS ORM","date":"November 22, 2023","description":"SQL 과 ORM 에 대해서 비교해보고 어떠한 부분에서 성능 저하가 발생했는지 비교해봤습니다.\n","author":{"name":"장진수","avatar":"https://avatars.githubusercontent.com/u/19955904","greeting":"원프레딕트 백엔드 엔지니어"}}},"previous":{"fields":{"slug":"/failure-retrospective/"},"frontmatter":{"title":"신입 개발자의 인덱스 장애 회고담"}},"next":{"fields":{"slug":"/about-scene/"},"frontmatter":{"title":"커스텀 대시보드를 위한 Scene"}}},"pageContext":{"id":"c024443e-e16e-5384-ad53-4e9c9208850e","previousPostId":"2a369d7d-ec92-5daf-a7da-f59b5735d54e","nextPostId":"fff4c166-9970-52c5-9b6b-e1431e5e9736"}},"staticQueryHashes":["2094693779"],"slicesMap":{}}