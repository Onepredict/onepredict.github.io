{"componentChunkName":"component---src-templates-blog-post-js","path":"/failure-retrospective/","result":{"data":{"site":{"siteMetadata":{"title":"Onepredict Engineering"}},"markdownRemark":{"id":"2a369d7d-ec92-5daf-a7da-f59b5735d54e","excerpt":"들어가며 Index란? Index를 사용하는 이유 Index…","html":"<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0\">들어가며</a></p>\n</li>\n<li>\n<p><a href=\"#index%EB%9E%80\">Index란?</a></p>\n<ul>\n<li><a href=\"#index%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-%EC%9D%B4%EC%9C%A0\">Index를 사용하는 이유</a></li>\n<li><a href=\"#index%EC%9D%98-%EB%B9%84%EC%9A%A9-%EB%B9%84%EB%8C%80%EC%B9%AD%EC%84%B1\">Index의 비용 비대칭성</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EC%84%A4%EC%A0%95-%EC%9E%A5%EC%95%A0-%EB%A6%AC%ED%8F%AC%ED%8A%B8\">인덱스 설정 장애 리포트</a></p>\n</li>\n<li>\n<p><a href=\"#%ED%9A%8C%EA%B3%A0\">회고</a></p>\n</li>\n</ul>\n</div>\n<h2 id=\"들어가며\" style=\"position:relative;\"><a href=\"#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0\" aria-label=\"들어가며 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>들어가며</h2>\n<p>데이터베이스의 인덱스를 잘 활용하면 놀라운 조회 성능 개선을 이룰 수 있습니다.\n하지만 운영되고 있는 서비스의 데이터베이스를 다룰 때는\n각별히 조심해서 써야 합니다.</p>\n<p>지금부터 제가 들려드릴 이야기는 만 1년이 안 된\n신입 개발자 시절 저지른 실수에 대한 회고입니다.\n부디 이 이야기가 여러분에게도 공감받고 작게나마 도움이 되었으면 좋겠습니다.</p>\n<h2 id=\"index란\" style=\"position:relative;\"><a href=\"#index%EB%9E%80\" aria-label=\"index란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Index란?</h2>\n<p>데이터베이스 테이블에 지정한 Column을 기준으로 메모리 영역에\n일종의 목차를 생성하는 것.</p>\n<h3 id=\"index를-사용하는-이유\" style=\"position:relative;\"><a href=\"#index%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-%EC%9D%B4%EC%9C%A0\" aria-label=\"index를 사용하는 이유 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Index를 사용하는 이유</h3>\n<p>데이터 조회(SELECT)의 성능을 향상하기 위해.</p>\n<h3 id=\"index의-비용-비대칭성\" style=\"position:relative;\"><a href=\"#index%EC%9D%98-%EB%B9%84%EC%9A%A9-%EB%B9%84%EB%8C%80%EC%B9%AD%EC%84%B1\" aria-label=\"index의 비용 비대칭성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Index의 비용 비대칭성</h3>\n<p>인덱스를 유지 관리하는 것은 비용이 듭니다.\n왜냐하면 데이터가 테이블에 삽입, 업데이트 또는 삭제되면\n해당 인덱스도 따라 업데이트되어야 하므로\n추가로 시간, 메모리를 사용하기 때문입니다.</p>\n<p>다시 말해 INSERT, UPDATE, DELETE(Command)의 성능을 희생하고\n대신 SELECT(Query)의 성능을 향상하기 위해서 인덱스를 사용하게 됩니다.\n이를 <strong>Command와 Query 비용의 비대칭성</strong>아라고 합니다.\n따라서 인덱스 생성 결정은 향상된 조회 성능과\n인덱스 유지 관리 비용 사이의 균형을 고려해서 결정해야 합니다.</p>\n<p>지금부터는 GuardiOne Turbo 제품의 인덱스 생성 관련해서 제가 일으킨 장애에 대해\n알아보겠습니다.</p>\n<h2 id=\"인덱스-설정-장애-리포트\" style=\"position:relative;\"><a href=\"#%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EC%84%A4%EC%A0%95-%EC%9E%A5%EC%95%A0-%EB%A6%AC%ED%8F%AC%ED%8A%B8\" aria-label=\"인덱스 설정 장애 리포트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>인덱스 설정 장애 리포트</h2>\n<p>인덱스 설정 업무를 하게 된 배경은 다음과 같습니다.</p>\n<ol>\n<li><strong>과거의 성공 경험</strong> - 인덱스가 없던 데이터 ETL 관련 테이블에\n인덱스 설정 후 코드 연산 속도 100배 향상 (300초 → 3초)</li>\n<li><strong>데이터 화면이 늦게 뜬다는 고객의 민원</strong></li>\n</ol>\n<p>1, 2의 이유로 API가 조회하는 Feature 테이블에 이미 단일 인덱스가 설정되어\n있지만,\n추가적인 속도 개선을 위해 복합 인덱스 설정이 필요하다는 결정이 있었습니다.</p>\n<p>그리고 복합 인덱스 설정을 한 다음 날 아침, 고객으로부터\n화면에서 보이는 데이터가 업데이트되지 않았다는 연락을 받았습니다.\nDB 도구로 확인해 보니 DB 테이블이 조회되지 않았습니다.\n장애 원인은 <strong>인덱스 설정으로 인한 DB 트랜잭션 과부하</strong>였습니다.</p>\n<p>인덱스 설정으로 인해 멀쩡하던 데이터가 들어오지 않는 건 큰일입니다.\n당황한 저는 문제를 일으킨 장본인인 내가 책임져야 한다는 생각에\n점심도 거르고 용량이 작은 테이블부터 인덱스 설정 롤백을 시도했습니다.\n하지만 설상가상으로 인덱스 삭제 또한 오래 걸려서 DB 과부하로\n모든 API 요청이 거절되어 화면이 제대로 나오지 않았습니다.</p>\n<p>주변 동료들의 도움을 받기 위해 위 상황을 알리고 같은 팀 동료의 도움으로\n위 상황을 해결할 수 있었습니다.\nPostgreSQL의 내장 함수를 통해 DB lock 걸린 프로세스를 강제 종료하고\n인덱스 설정을 롤백하여 문제를 해결할 수 있었습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">FROM</span> pg_catalog<span class=\"token punctuation\">.</span>pg_stat_activity<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> t<span class=\"token punctuation\">.</span>relname<span class=\"token punctuation\">,</span> l<span class=\"token punctuation\">.</span>locktype<span class=\"token punctuation\">,</span> page<span class=\"token punctuation\">,</span> virtualtransaction<span class=\"token punctuation\">,</span> pid<span class=\"token punctuation\">,</span> <span class=\"token keyword\">mode</span><span class=\"token punctuation\">,</span> granted\n<span class=\"token keyword\">FROM</span> pg_catalog<span class=\"token punctuation\">.</span>pg_locks l<span class=\"token punctuation\">,</span> pg_catalog<span class=\"token punctuation\">.</span>pg_stat_all_tables t\n<span class=\"token keyword\">WHERE</span> l<span class=\"token punctuation\">.</span>relation <span class=\"token operator\">=</span> t<span class=\"token punctuation\">.</span>relid\n<span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> relation <span class=\"token keyword\">ASC</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> pg_cancel_backend<span class=\"token punctuation\">(</span><span class=\"token number\">8100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> pg_terminate_backend<span class=\"token punctuation\">(</span><span class=\"token number\">20500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">pg_cancel_backend()</code> 함수를 통해\n특정 백엔드 프로세스의 실행을 취소할 수 있기 때문에,\n백엔드 프로세스의 PID를 <code class=\"language-text\">pg_cancel_backend()</code>에 대한 인수로 제공해서\n해당 프로세스를 종료했습니다.</p>\n<h2 id=\"회고\" style=\"position:relative;\"><a href=\"#%ED%9A%8C%EA%B3%A0\" aria-label=\"회고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>회고</h2>\n<p>원프레딕트에선 스프린트가 종료될 때마다 회고를 통해 아쉬웠던 점은 개선하고,\n잘한 점은 서로 칭찬하고 유지하려 모두 노력하고 있습니다.</p>\n<p>이번 사고에서도 예방책에 관해 스프린트 회고 때 많은 의견이 있었습니다.</p>\n<ul>\n<li>운영 중인 서비스와 관련한 작업을 할 때는 경각심 갖기</li>\n<li>운영 데이터베이스 조작 전 PO나 팀원에게 공유하기</li>\n<li>운영 데이터베이스를 조작하는 권한에 대한 내규나 프로세스 만들기</li>\n</ul>\n<p>모두 다 좋은 의견입니다.\n여기에 더해서 저는 <code class=\"language-text\">비판적으로 일하기</code>의 중요성을 배웠습니다.\n앞서 말씀드렸듯이 테이블마다 필요한 단일 인덱스는 이미 설정되어 있었습니다.\n복합 인덱스 설정이 크게 조회 성능이 되지 않을 수 있는 점과\nCommand의 비용이 더 들 수 있다는 점을 간과했다는 점이 아쉬웠습니다.\n업무 지시를 받은 상황이라도 그것이 정말로 도움이 되는지,\n어떤 가치를 줄 수 있는지를 주체적으로 생각해야 했다는 점을 배웠습니다.</p>\n<p>이 주제로 백엔드 작당모의<sup id=\"fnref-주1\"><a href=\"#fn-주1\" class=\"footnote-ref\">주1</a></sup>에서 발표했을 때 저는 조금 긴장했습니다.\n회사에서 자신의 성과가 아닌 실수를 드러내는 건 용기가 필요한 일이니까요.\n하지만 발표를 마치고 동료들이 저마다 자신이 겪었던 실수를 공유하고\n누구도 비난하지 않는 분위기를 보며\n원프레딕트의 개발 조직은 좋은 문화를 가지고 있다는 확신을 얻게 되었습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9a58d2e0e4117fcb4ccd1b4aaa3aabd9/699b7/strategies_for_learning_from_failure.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABgklEQVR42nVS2YrCQBDM/3+HT3lR9CWIiLei4oGgBhWNeN/3gUctVcsEcdmBTvd099RU18Tq9XpoNBqo1WpwXRedTgf9fl+5drutPa3ZbCq32+2w2WywWCyw3W61n0wmWK1WOJ/PsBhMp1PMZjM1rtdrFZfLpbwx5ufzOS6XC+73O67XK263m4zx8/mUCTAWiyGdTotJt9tFPp9HpVIB2UciEdi2jVKphFwupz56TlEoFNQbjUZ1jssiKpkRmAwY0xibHJs5Bcc8nU5ia8Y+Ho+ahn0CPBwOyGQyGAwGYlEul1EsFnUzNWU+lUohkUhIU2pJ9tVqVboHg0HVW63WL+D7/dZt1IaikgHZ0Cj4fr/HeDwWA9aYIwkyox+NRtKf5wXIz3A49FlQIxqZ0cfjcTGu1+sIh8MIBAKaIpvNSnPWHceBWQJ8vV668VNDw4QMqRH1Mi/NScxrM+ZZTuoDfi9T5NjUNxQKIZlMwvM8v/bfsj5BTLPx5h8zjB6Px59Lv+Mfumjiuwd2sSIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"영리한 실패\"\n        title=\"\"\n        src=\"/static/9a58d2e0e4117fcb4ccd1b4aaa3aabd9/0b533/strategies_for_learning_from_failure.png\"\n        srcset=\"/static/9a58d2e0e4117fcb4ccd1b4aaa3aabd9/fac75/strategies_for_learning_from_failure.png 125w,\n/static/9a58d2e0e4117fcb4ccd1b4aaa3aabd9/63868/strategies_for_learning_from_failure.png 250w,\n/static/9a58d2e0e4117fcb4ccd1b4aaa3aabd9/0b533/strategies_for_learning_from_failure.png 500w,\n/static/9a58d2e0e4117fcb4ccd1b4aaa3aabd9/699b7/strategies_for_learning_from_failure.png 596w\"\n        sizes=\"(max-width: 500px) 100vw, 500px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>실수하지 않는 사람은 없습니다.\n여러 사람이 모인 회사 안에서 아무런 사건 사고가 없다면 그건 오히려 사람들이\n비난이 두려워 자신의 실수를 감추고 있다는 방증일 것입니다.\n원프레딕트에서는 실수가 있어도 그것을 숨기지 않으며\n그를 통해 배우고 더 영리한 조직이 되고자 노력합니다.\n원프레딕트와 함께 성장하고 싶은 분은 언제든 문을 두드려 주세요!</p>\n<p><strong><a href=\"https://blog.onepredict.ai/\">원프레딕트 채용 정보 확인하기</a></strong></p>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-주1\">원프레딕트의 모든 백엔드 엔지니어는 매주 목요일에\n기술 주제를 나누는데, 이 모임의 이름이 ‘백엔드 작당모의’입니다.<a href=\"#fnref-%EC%A3%BC1\" class=\"footnote-backref\">↩</a></li>\n</ol>\n</div>","fields":{"slug":"/failure-retrospective/"},"frontmatter":{"title":"신입 개발자의 인덱스 장애 회고담","date":"November 15, 2023","description":"당신은 어떤 개발 문화에서 일하고 있나요?","author":{"name":"김아별","avatar":"https://avatars.githubusercontent.com/u/109946046?v=4","greeting":"원프레딕트 백엔드 엔지니어"}}},"previous":{"fields":{"slug":"/reactive-programming/"},"frontmatter":{"title":"반응형 프로그래밍이란 무엇인가?"}},"next":{"fields":{"slug":"/sql-orm/"},"frontmatter":{"title":"SQL VS ORM"}}},"pageContext":{"id":"2a369d7d-ec92-5daf-a7da-f59b5735d54e","previousPostId":"af0f498e-421d-56f0-9dc3-c6d452bd4e5b","nextPostId":"c024443e-e16e-5384-ad53-4e9c9208850e"}},"staticQueryHashes":["2094693779"],"slicesMap":{}}